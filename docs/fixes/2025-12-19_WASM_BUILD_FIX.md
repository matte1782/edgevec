# WASM Build Fix — Corrupted pkg/package.json

**Date:** 2025-12-19
**Priority:** P0 (CRITICAL)
**Status:** FIX IDENTIFIED — REQUIRES MANUAL EXECUTION
**Agent:** HOSTILE_REVIEWER + WASM_SPECIALIST

---

## Problem Summary

wasm-pack build is failing with:
```
Error: invalid type: map, expected a string at line 2 column 18
```

## Root Cause

**The `pkg/package.json` file is corrupted:**

**Current (BROKEN):**
```json
{
  "dependencies": {
    "edgevec": "^0.5.1"
  }
}
```

**Expected (wasm-pack generated):**
```json
{
  "name": "edgevec",
  "version": "0.5.3",
  ...
}
```

wasm-pack expects `"name"` as the first field but finds `"dependencies"` (a map type), causing the parse error.

---

## IMMEDIATE FIX

### Step 1: Replace pkg/package.json

**Option A: Manual Edit**

Replace the contents of `pkg/package.json` with:

```json
{
  "name": "edgevec",
  "version": "0.5.3",
  "description": "High-performance embedded vector database for Browser, Node, and Edge",
  "main": "edgevec.js",
  "types": "edgevec.d.ts",
  "module": "edgevec.js",
  "sideEffects": [
    "./snippets/*"
  ],
  "files": [
    "edgevec.js",
    "edgevec.d.ts",
    "edgevec_bg.wasm",
    "edgevec_bg.wasm.d.ts"
  ],
  "repository": {
    "type": "git",
    "url": "https://github.com/matte1782/edgevec"
  },
  "keywords": [
    "vector",
    "database",
    "wasm",
    "hnsw",
    "similarity-search"
  ],
  "license": "MIT OR Apache-2.0"
}
```

**Option B: Delete and Rebuild**

```bash
# Delete the corrupted package.json
rm pkg/package.json

# Rebuild (wasm-pack will generate fresh package.json)
wasm-pack build --target web --out-dir pkg
```

### Step 2: Verify Build Succeeds

```bash
wasm-pack build --target web --out-dir pkg
```

Expected output:
```
[INFO]: Compiling to Wasm...
[INFO]: Installing wasm-bindgen...
[INFO]: Optimizing wasm binaries with `wasm-opt`...
[INFO]: Done in X.XXs
```

### Step 3: Verify parse_filter_js Export

```bash
grep "export function parse_filter_js" pkg/edgevec.js
```

Expected output:
```
export function parse_filter_js(filter_str) {
```

---

## Verification Checklist

After fix:

- [ ] `wasm-pack build --target web --out-dir pkg` succeeds
- [ ] `pkg/package.json` has `"name": "edgevec"` as first field
- [ ] `grep "parse_filter_js" pkg/edgevec.js` shows export
- [ ] Demo pages load without "parse_filter_js is not a function" error

---

## Related iOS Safari Issues

**IMPORTANT:** The current WASM build (from Dec 19 23:48) **ALREADY HAS parse_filter_js exported** at `pkg/edgevec.js:2189`. The iOS Safari issue may be:

1. **A different package.json was served** (npm installed wrong version)
2. **Module caching issue** on iOS Safari
3. **Actual runtime error** not caught

### Additional iOS Investigation

After fixing the build, test on iOS Safari with:

```javascript
// In browser console on iOS
import * as wasm from './pkg/edgevec.js';
await wasm.default();
console.log('parse_filter_js:', typeof wasm.parse_filter_js);
```

Expected: `parse_filter_js: function`

If still undefined on iOS:
- Clear Safari cache completely
- Check if a different edgevec version is cached
- Use Safari Web Inspector (from Mac) to debug

---

## Prevention

To prevent this issue in future:

1. **Add pkg/package.json to .gitignore** (it's generated by wasm-pack)
2. **Don't manually edit pkg/package.json**
3. **Add CI check** that verifies wasm-pack build succeeds

---

**Fix Author:** HOSTILE_REVIEWER + WASM_SPECIALIST
**Verification Required:** Manual execution by user

# EdgeVec v0.8.0 Consolidation Plan

**Date:** 2025-12-23
**Author:** PLANNER
**Based On:** `docs/audits/CODE_CONSOLIDATION_AUDIT.md`
**Status:** PROPOSED

---

## Executive Summary

This plan addresses code consolidation opportunities identified in the W30.0.3 audit. The goal is to eliminate redundancy, improve SIMD coverage, and create a unified dispatch pattern for v0.8.0.

**Scope:** 3 work items, ~12 hours total

---

## Work Items

### W8.1: SIMD Euclidean Distance (4h)

**Problem:** Euclidean distance currently uses scalar implementation on x86_64 and WASM platforms, while NEON has SIMD.

**Solution:** Add SIMD implementations for x86_64 (SSE/AVX) and WASM (SIMD128).

**Files to Modify:**
- `src/metric/simd.rs` - Add `wasm::euclidean_distance` and `x86::euclidean_distance`
- `src/metric/l2.rs` - Update dispatcher to use SIMD when available

**Algorithm:**
```rust
// WASM SIMD128 euclidean distance
pub fn euclidean_distance(a: &[f32], b: &[f32]) -> f32 {
    let mut sum = f32x4_splat(0.0);
    // Process 4 floats at a time
    for chunk in a.chunks(4).zip(b.chunks(4)) {
        let va = v128_load(a_ptr);
        let vb = v128_load(b_ptr);
        let diff = f32x4_sub(va, vb);
        sum = f32x4_add(sum, f32x4_mul(diff, diff));
    }
    // Horizontal sum + sqrt
    f32x4_extract_lane::<0>(sum) + ... + sqrt
}
```

**Acceptance Criteria:**
- [ ] `metric/simd.rs` has WASM euclidean_distance
- [ ] `metric/simd.rs` has x86 euclidean_distance
- [ ] `metric/l2.rs` dispatches to SIMD when available
- [ ] Unit tests pass
- [ ] Benchmark shows 2x+ speedup over scalar

---

### W8.2: Unified SIMD Dispatch Macro (4h)

**Problem:** Each SIMD function manually implements the same dispatch pattern:
```rust
#[cfg(target_arch = "x86_64")]
if is_x86_feature_detected!("avx2") {
    return unsafe { avx2_impl(...) };
}
// ... more platforms
fallback_impl(...)
```

**Solution:** Create a `simd_dispatch!` macro that handles platform detection and dispatch.

**Files to Create/Modify:**
- `src/simd/dispatch.rs` - New file with macro definition
- `src/simd/mod.rs` - Export the macro
- `src/simd/popcount.rs` - Refactor to use macro (demonstration)

**Design:**
```rust
/// Unified SIMD dispatch macro.
///
/// # Example
/// ```
/// simd_dispatch! {
///     fn my_function(a: &[u8], b: &[u8]) -> u32 {
///         avx2: unsafe { avx2_impl(a, b) },
///         neon: unsafe { neon_impl(a, b) },
///         wasm_simd: simd_impl(a, b),
///         fallback: scalar_impl(a, b),
///     }
/// }
/// ```
macro_rules! simd_dispatch {
    (
        fn $name:ident($($arg:ident: $type:ty),*) -> $ret:ty {
            $(avx2: $avx2:expr,)?
            $(neon: $neon:expr,)?
            $(wasm_simd: $wasm:expr,)?
            fallback: $fallback:expr $(,)?
        }
    ) => {
        pub fn $name($($arg: $type),*) -> $ret {
            #[cfg(target_arch = "x86_64")]
            {
                $(
                    if is_x86_feature_detected!("avx2") {
                        return $avx2;
                    }
                )?
            }
            #[cfg(target_arch = "aarch64")]
            {
                $(
                    if std::arch::is_aarch64_feature_detected!("neon") {
                        return $neon;
                    }
                )?
            }
            #[cfg(all(target_arch = "wasm32", target_feature = "simd128"))]
            {
                $(return $wasm;)?
            }
            $fallback
        }
    };
}
```

**Acceptance Criteria:**
- [ ] `simd_dispatch!` macro defined and documented
- [ ] At least one function refactored to use macro
- [ ] Compile tests pass on all targets
- [ ] Generated code matches manual dispatch

---

### W8.3: SIMD Architecture Documentation (4h)

**Problem:** The SIMD codebase is complex with multiple dispatch layers. New contributors struggle to understand the architecture.

**Solution:** Create comprehensive architecture documentation with diagrams.

**Files to Create:**
- `docs/architecture/SIMD_ARCHITECTURE.md` - Full architecture guide

**Content:**
1. **Overview Diagram:** Show dispatch flow from public API to platform implementations
2. **Module Responsibilities:** Explain each module's role
3. **Performance Expectations:** Document expected speedups per platform
4. **Adding New Operations:** Step-by-step guide for adding SIMD ops
5. **Testing Strategy:** How to test SIMD code on different platforms

**Diagram (ASCII):**
```
┌─────────────────────────────────────────────────────────────────┐
│                        Public API                                │
│    hamming_distance()    dot_product()    euclidean_distance()   │
└───────────────┬──────────────┬─────────────────┬─────────────────┘
                │              │                 │
                ▼              ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Platform Dispatcher                           │
│    simd_dispatch! { avx2 | neon | wasm_simd | fallback }        │
└───────────────┬──────────────┬─────────────────┬─────────────────┘
                │              │                 │
        ┌───────┴───────┐      │      ┌──────────┴──────────┐
        ▼               ▼      ▼      ▼                     ▼
┌──────────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ ┌──────────┐
│    AVX2      │ │   NEON   │ │  WASM    │ │ Scalar  │ │  Tests   │
│  (x86_64)    │ │ (aarch64)│ │ SIMD128  │ │Fallback │ │   All    │
│  <50 cycles  │ │ <50 cy   │ │ <100 cy  │ │~300 cy  │ │Platforms │
└──────────────┘ └──────────┘ └──────────┘ └─────────┘ └──────────┘
```

**Acceptance Criteria:**
- [ ] Architecture diagram included
- [ ] All modules documented
- [ ] Performance expectations listed
- [ ] "How to add SIMD" guide complete
- [ ] Hostile review approved

---

## Timeline

| Week | Work Item | Hours | Deliverable |
|:-----|:----------|:------|:------------|
| 32 | W8.1 SIMD Euclidean | 4h | `metric/simd.rs` updated |
| 32 | W8.2 Dispatch Macro | 4h | `simd/dispatch.rs` created |
| 33 | W8.3 Documentation | 4h | `SIMD_ARCHITECTURE.md` |

**Total:** 12 hours across 2 weeks

---

## Dependencies

- v0.7.0 must be released first (SIMD enabled in WASM)
- Week 30-31 work must complete before W8.x begins

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|:-----|:-----------|:-------|:-----------|
| Macro complexity | Medium | Medium | Start with simple case, expand |
| Platform testing | Low | High | CI covers all platforms |
| Breaking changes | Low | Low | Internal refactor only |

---

## Non-Goals for v0.8.0

The following are explicitly **out of scope**:
- Removing any existing platform-specific implementations
- Changing public API signatures
- Adding new distance metrics
- SIMD for ARM32 (only aarch64 supported)

---

**Author:** PLANNER
**Date:** 2025-12-23
**Status:** PROPOSED - Awaiting Week 30 completion
